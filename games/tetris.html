<!DOCTYPE html>
<html lang="en-US">
    <head>
        <!-- DYNAMIC BETWEEN PAGES -->
        <meta property="og:title" content="TETRIS ;]" id="title" />
        <meta property="og:description" content="A simple game of tetris" />
        <meta name="description" content="A simple game of tetris" />

        <!-- STATIC BETWEEN PAGES -->
        <meta property="og:type" content="website" />
        <meta property="og:image" content="/prizm.dev/assets/image/favicon.png" />
        <meta property="og:image:type" content="image/png" />
        <meta property="og:image:width" content="256" />
        <meta property="og:image:height" content="256" />
        <meta property="og:url" content="https://voxelprismatic.github.io/prizm.dev/" />
        <title>TETRIS ;]</title>
        <link rel="icon" type="image/png" href="/prizm.dev/assets/image/favicon.png" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta property="og:url" content="https://voxelprismatic.github.io/prizm.dev/" />
        <meta name="author" content="PRIZ ;]" />
        <style type="text/css">
            * {
                font-family: "Ubuntu Mono";
            } #head {
                top: -100px !important;
            } #keys tr:nth-child(odd) {
                background-color: #233;
            } #keys tr:first-child {
                background-color: #344;
            } #keys td, #keys th {
                margin: 5px;
                padding: 5px;
            } pre#logo {
                width: 100%;
                text-align: center;
                font-weight: bold;
                font-size: 24px;
                color: #0ff;
            } .board {
                margin: auto;
                border-spacing: 0px;
            } .board td {
                height: 18px;
                width: 18px;
                border: 2px #0000 solid;
                transition: all 0.1s cubic-bezier(0, 0.5, 0, 1);
            } .board.main td {
                background-color: #233;
                border: 2px #122 solid;
            } .cyan {
                background-color: #0ff !important;
                border: 2px #0ff solid !important;
                transition: none !important;
            } .nuclear {
                background-color: #8f0 !important;
                border: 2px #8f0 solid !important;
                transition: none !important;
            } .magenta {
                background-color: #f0f !important;
                border: 2px #f0f solid !important;
                transition: none !important;
            } .purple {
                background-color: #80f !important;
                border: 2px #80f solid !important;
                transition: none !important;
            } .seafoam {
                background-color: #0f8 !important;
                border: 2px #0f8 solid !important;
                transition: none !important;
            } .seawater {
                background-color: #08f !important;
                border: 2px #08f solid !important;
                transition: none !important;
            } .blue {
                background-color: #00f !important;
                border: 2px #00f solid !important;
                transition: none !important;
            } .orange {
                background-color: #f80 !important;
                border: 2px #f80 solid !important;
                transition: none !important;
            } .yellow {
                background-color: #ff0 !important;
                border: 2px #ff0 solid !important;
                transition: none !important;
            } .green {
                background-color: #0f0 !important;
                border: 2px #0f0 solid !important;
                transition: none !important;
            } .red {
                background-color: #f00 !important;
                border: 2px #f00 solid !important;
                transition: none !important;
            } .pink {
                background-color: #f08 !important;
                border: 2px #f08 solid !important;
                transition: none !important;
            } .garbage {
                background-color: #666 !important;
                border: 2px #666 solid !important;
                transition: none !important;
            } .cleared td {
                background-color: #fff !important;
                border: 2px #fff solid !important;
                transition: none !important;
            } h1, h3, details {
                color: #0ff;
                text-align: center;
            } .mid {
                position: absolute;
                left: 50%;
                transform: translateX(-50%);
            } .noopac {
                opacity: 0 !important;
            } summary h3 {
                display: inline-block;
            } button {
                background-color: #0ff4;
                border: 2px solid #0ff;
                color: #0ff;
                border-radius: 4px;
                padding: 10px;
                margin: 10px;
                height: 37px;
                width: 37px;
                font-size: 18px;
                font-weight: bold;
            }

            .board.ed td:first-child,
            .board.ed td:last-child,
            .board.ed td:nth-child(2),
            .board.ed td:nth-last-child(2),
            .board.ed td:nth-child(3),
            .board.ed td:nth-last-child(3),
            .board.ed td:nth-child(4),
            .board.ed td:nth-last-child(4),
            .board.ed tr:first-child td,
            .board.ed tr:last-child td,
            .board.ed tr:nth-child(2) td,
            .board.ed tr:nth-last-child(2) td,
            .board.ed tr:nth-child(3) td,
            .board.ed tr:nth-last-child(3) td,
            .board.ed tr:nth-child(4) td,
            .board.ed tr:nth-last-child(4) td  {
                height: 0px;
                width: 0px;
                padding: 0px;
                border: none !important;
                background-color: #0000 !important;
                display: none;
            }

            #fuckme {
                line-height: 8px;
                font-size: 75%;
                height: 20px;
            }
        </style>
    </head>
    <body class="bgcolor" style="background-color: #122">
        <pre id="logo">
______________________
|                    |
|  T  E  T  R  I  S  |
|______        ______|
|      |
|      |
|______|

<i>~priz edition~</i>
        </pre>
        <div style="text-align: center">
            <details>
                <summary><h3>Key map</h3></summary>
                <table style="color: #ccc; margin: auto;" id="keys">
                    <tr>
                        <th>Key</th>
                        <th>Action</th>
                    </tr>
                    <tr>
                        <td>&Lambda;, W, E</td>
                        <td>Rotate piece right</td>
                    </tr>
                    <tr>
                        <td>/, Q, Z</td>
                        <td>Rotate piece left</td>
                    </tr>
                    <tr>
                        <td>&lt;, A</td>
                        <td>Move piece right</td>
                    </tr>
                    <tr>
                        <td>&gt;, D</td>
                        <td>Move piece left</td>
                    </tr>
                    <tr>
                        <td>V, S</td>
                        <td>Move piece down</td>
                    </tr>
                    <tr>
                        <td>Space, Enter</td>
                        <td>Drop piece to bottom</td>
                    </tr>
                    <tr>
                        <td>C, CTRL</td>
                        <td>Swap piece</td>
                    </tr>
                    <tr>
                        <td>G</td>
                        <td>Add garbage</td>
                    </tr>
                </table>
            </details>
            <details>
                <summary><h3>Settings</h3></summary>
                <table style='color: #ccc; margin: auto;' id="keys">
                    <tr>
                        <th>Option</th>
                        <th>Value</th>
                    </tr>
                    <tr>
                        <td>Garbage</td>
                        <td><input type="checkbox" id="garbage" onchange="garbage_enabled = this.value;localStorage.getItem('__tetris__garbage', Number(this.value))"></input></td>
                    </tr>
                    <tr>
                        <td>Speed</td>
                        <td><input type="range" id="speed" min="0" max="10" value="5"
                                   onchange="interval=this.value;change_interval();localStorage.setItem('__tetris__speed', this.value)"></input></td>
                    </tr>
                    <tr>
                        <td>Ghost tetrimino</td>
                        <td><input type="checkbox" id="ghost" onchange="localStorage.setItem('__tetris__ghost', Number($('#predict').classList.toggle('noopac')))" checked=''></input></td>
                    </tr>
                    <tr>
                        <td>Funky tetriminos</td>
                        <td><input type="checkbox" id="extras" onchange="extra_bits=this.checked;localStorage.setItem('__tetris__extras', Number(extra_bits))"></input></td>
                    </tr>
                    <tr>
                        <td>Width<br><sub><i>*Will reset the game</i></sub></td>
                        <td><input type="number" id="width" min="5" value="10" onchange="maxX=Number(this.value)+8;board_size()"></input></td>
                    </tr>
                    <tr>
                        <td>Height<br><sub><i>*Will reset the game</i></sub></td>
                        <td><input type="number" id="height" min="10" value="20" onchange="maxY=Number(this.value)+8;board_size()"></input></td>
                    </tr>
                </table>
            </details>
        </div>
        <div>
            <h1>-- Next piece --</h1>
            <table class='board main' id="next_piece">
                <tr> <td></td> <td></td> <td></td> <td></td> </tr>
                <tr> <td></td> <td></td> <td></td> <td></td> </tr>
            </table>
            <h3>Score: <span id='score'>0</span> // Level: <span id='level'>1</span></h3>
            <h1>-- Board --</h1>
            <table class='board main ed mid' id="grid">
            </table>

            <table class='board ed mid' style='opacity: 50%' id="predict">
            </table>

            <table class='board ed mid' id="dropping">
            </table>

            <table class='board ed' style='position: relative; z-index: 100;' id="floating">
            </table>

            <div style="text-align: center;">
                <button onclick='rotate_piece(-1)'>&lt;O</button><button onclick='rotate_piece()'>&Lambda;</button><button onclick='rotate_piece()'>O&gt;</button> <br>
                <button onclick='move_piece_left()'>&lt;</button><button onclick='move_piece_down()'>V</button><button onclick='move_piece_right()'>&gt;</button> <br>
                <button onclick='add_garbage()'>.:</button><button onclick='drop_piece()'>VV</button><button onclick='swap_piece()'><div id='fuckme'><--<br>--></div></button>
            </div>

        </div>
        <div id="content">
            <script type="text/javascript">
                function $(...a) { return document.querySelector(...a); }
                let pieces = {
                    "I": {
                        0: [
                            "    ",
                            "####",
                            "    ",
                            "    "
                        ],
                        1: [
                            "  # ",
                            "  # ",
                            "  # ",
                            "  # "
                        ],
                        2: [
                            "    ",
                            "    ",
                            "####",
                            "    "
                        ],
                        3: [
                            " #  ",
                            " #  ",
                            " #  ",
                            " #  "
                        ]
                    },
                    "J": {
                        0: [
                            "#  ",
                            "###",
                            "   "
                        ],
                        1: [
                            " ##",
                            " # ",
                            " # "
                        ],
                        2: [
                            "   ",
                            "###",
                            "  #"
                        ],
                        3: [
                            " # ",
                            " # ",
                            "## "
                        ]
                    },
                    "L": {
                        0: [
                            "  #",
                            "###",
                            "   "
                        ],
                        1: [
                            " # ",
                            " # ",
                            " ##"
                        ],
                        2: [
                            "   ",
                            "###",
                            "#  "
                        ],
                        3: [
                            "## ",
                            " # ",
                            " # "
                        ]
                    },
                    "O": {
                        0: [
                            " ## ",
                            " ## ",
                            "    "
                        ],
                        1: [
                            " ## ",
                            " ## ",
                            "    "
                        ],
                        2: [
                            " ## ",
                            " ## ",
                            "    "
                        ],
                        3: [
                            " ## ",
                            " ## ",
                            "    "
                        ]
                    },
                    "S": {
                        0: [
                            " ##",
                            "## ",
                            "   "
                        ],
                        1: [
                            " # ",
                            " ##",
                            "  #"
                        ],
                        2: [
                            "   ",
                            " ##",
                            "## "
                        ],
                        3: [
                            "#  ",
                            "## ",
                            " # "
                        ]
                    },
                    "T": {
                        0: [
                            " # ",
                            "###",
                            "   "
                        ],
                        1: [
                            " # ",
                            " ##",
                            " # "
                        ],
                        2: [
                            "   ",
                            "###",
                            " # "
                        ],
                        3: [
                            " # ",
                            "## ",
                            " # "
                        ]
                    },
                    "Z": {
                        0: [
                            "## ",
                            " ##",
                            "   "
                        ],
                        1: [
                            "  #",
                            " ##",
                            " # "
                        ],
                        2: [
                            "   ",
                            "## ",
                            " ##"
                        ],
                        3: [
                            " # ",
                            "## ",
                            "#  "
                        ]
                    },
                    "Q": {
                        0: [
                            "    ",
                            " # #",
                            "# # ",
                            "    "
                        ],
                        1: [
                            " #  ",
                            "  # ",
                            " #  ",
                            "  # "
                        ],
                        2: [
                            "    ",
                            " # #",
                            "# # ",
                            "    "
                        ],
                        3: [
                            " #  ",
                            "  # ",
                            " #  ",
                            "  # "
                        ]
                    },
                    "P": {
                        0: [
                            "    ",
                            "# # ",
                            " # #",
                            "    "
                        ],
                        1: [
                            "  # ",
                            " #  ",
                            "  # ",
                            " #  "
                        ],
                        2: [
                            "    ",
                            "# # ",
                            " # #",
                            "    "
                        ],
                        3: [
                            "  # ",
                            " #  ",
                            "  # ",
                            " #  "
                        ]
                    },
                    "/": {
                        0: [
                            "    ",
                            "  ##",
                            "##  ",
                            "    "
                        ],
                        1: [
                            " #  ",
                            " #  ",
                            "  # ",
                            "  # "
                        ],
                        2: [
                            "    ",
                            "  ##",
                            "##  ",
                            "    "
                        ],
                        3: [
                            " #  ",
                            " #  ",
                            "  # ",
                            "  # "
                        ]
                    },
                    "\\": {
                        0: [
                            "    ",
                            "##  ",
                            "  ##",
                            "    "
                        ],
                        1: [
                            "  # ",
                            "  # ",
                            " #  ",
                            " #  "
                        ],
                        2: [
                            "    ",
                            "##  ",
                            "  ##",
                            "    "
                        ],
                        3: [
                            "  # ",
                            "  # ",
                            " #  ",
                            " #  "
                        ]
                    },
                    "=": {
                        0: [
                            "    ",
                            "#  #",
                            "#  #",
                            "    "
                        ],
                        1: [
                            " ## ",
                            "    ",
                            "    ",
                            " ## "
                        ],
                        2: [
                            "    ",
                            "#  #",
                            "#  #",
                            "    "
                        ],
                        3: [
                            " ## ",
                            "    ",
                            "    ",
                            " ## "
                        ]
                    }
                }
                let colors = {
                    "I": "cyan",
                    "J": "blue",
                    "L": "orange",
                    "O": "yellow",
                    "S": "green",
                    "T": "pink",
                    "Z": "red",
                    "/": "magenta",
                    "\\": "purple",
                    "Q": "seafoam",
                    "P": "nuclear",
                    "=": "seawater"
                }
                var bag = [];
                var extra_bits = false;
                function fillbag() {
                    bag = ["I", "J", "L", "O", "S", "T", "Z"]
                    if(extra_bits)
                        bag.push("P", "/", "\\", "Q", "=")
                }
                var next_piece
                var current_piece
                var score = 0;
                var cleared_total = 0;
                var garbage_enabled = false;
                var interval = 0;
                var board_st = ""

                function board_size() {
                    tables = [
                        $("#grid"),
                        $("#predict"),
                        $("#floating"),
                        $("#dropping")
                    ]
                    board_st = ""
                    for(y = 0; y < maxY; y += 1) {
                        board_st += "<tr> "
                        for(var x = 0; x < maxX; x += 1)
                            board_st += "<td></td> "
                        board_st += "</tr>\n"
                    }
                    for(var t of tables) {
                        try {
                            for(var y = 0; y < maxY; y += 1)
                                t.rows[0].remove();
                        } catch(err) {
                        }
                        t.innerHTML = board_st;
                    }

                    localStorage.setItem("__tetris__width", maxX)
                    localStorage.setItem("__tetris__height", maxY)
                    score = 0;
                    fillbag();
                    draw_next_piece();
                    next_piece_on_board();
                    w = $("#floating").clientWidth + "px";
                    h = $("#floating").clientHeight + "px";
                    $("#grid").style.width = w;
                    $("#predict").style.width = w;
                    $("#dropping").style.width = w;
                    $("#grid").style.height = h;
                    $("#predict").style.height = h;
                    $("#dropping").style.height = h;

                }

                function redraw_next_piece() {
                    table = $("#next_piece");
                    grid = pieces[next_piece][0]
                    color = colors[next_piece]
                    offset = 0
                    if(grid[0] == "    ")
                        offset = 1
                    for(var y = 0; y < 2; y += 1) {
                        for(var x = 0; x < 4; x += 1) {
                            cell = table.rows[y].cells[x]
                            if(x < grid[0].length)
                                cell.className = (grid[y + offset][x] == " " ? "" : color)
                            else
                                cell.removeAttribute("class")
                        }
                    }
                }

                function draw_next_piece() {
                    if(bag.length == 0)
                        fillbag();
                    next_piece = bag[Math.floor(Math.random() * bag.length)]
                    bag = bag.filter((i) => {return i != next_piece})
                    redraw_next_piece();
                    return next_piece
                }

                var posX = 0 // X position
                var posY = 0 // Y position
                var posR = 0 // Rotation
                var preY = 0 // Predict Y position
                var level = 1;

                function redraw_piece(table = $("#floating"), curY = posY, curX = posX, curR = posR, curQ = current_piece) {
                    for(var elem of table.querySelectorAll("td[class]"))
                        elem.className = ""
                    grid = pieces[curQ][curR]
                    color = colors[curQ]
                    for(var y = 0; y < grid.length; y += 1) {
                        for(var x = 0; x < grid[0].length; x += 1) {
                            table.rows[curY + y].cells[curX + x].className = (grid[y][x] == " " ? "" : color)
                        }
                    }
                }

                function add_garbage() {
                    t = $("#grid")
                    for(var y = 4; y < maxY - 4; y += 1) {
                        clean = true;
                        for(var x = 0; x < maxX; x += 1) {
                            if(t.rows[y].cells[x].className)
                                clean = false;
                        }
                        if(clean) {
                            t.rows[y].remove();
                            t.insertRow(maxY - 5);
                            for(var x = 0; x < 4; x += 1)
                                t.rows[maxY - 5].insertCell();
                            for(var x = 4; x < maxX - 4; x += 1) {
                                t.rows[maxY - 5].insertCell();
                                if(Math.floor(Math.random() * 2))
                                    t.rows[maxY - 5].cells[x].className = "garbage"
                            }
                            for(var x = 0; x < 4; x += 1)
                                t.rows[maxY - 5].insertCell();
                            predict();
                            if(conflicting())
                                game_over()
                            return
                        }
                    }
                    game_over();
                }

                function predict() {
                    ogY = posY
                    while(!conflicting($("#predict")))
                        posY += 1;
                    posY -= 1;
                    preY = posY;
                    redraw_piece($("#predict"))
                    posY = ogY
                    redraw_piece();
                    $("#score").innerHTML = score;
                    $("#level").innerHTML = level;
                }

                function conflicting(table1 = $("#floating"), curY = posY, curX = posX, curR = posR, curQ = current_piece) {
                    table2 = $("#grid")
                    try {
                        redraw_piece(table1, curY, curX, curR, curQ)
                    } catch(err) {
                        return true;
                    }
                    grid = pieces[curQ][curR]
                    var st = ""
                    invalidX = [0, 1, 2, 3, maxX - 4, maxX - 3, maxX - 2, maxX - 1]
                    invalidY = [0, 1, 2, 3, maxY - 4, maxY - 3, maxY - 2, maxY - 1]
                    for(var y = curY; y < curY + grid.length; y += 1) {
                        for(var x = curX; x < curX + grid[0].length; x += 1) {
                            s = table1.rows[y].cells[x].className
                            if(invalidX.includes(x) || invalidY.includes(y)) {
                                if(s) {
                                    if(invalidY.includes(y)) {
                                        if([0, 1, 2, 3].includes(y))
                                            curY += (4 - y);
                                        else
                                            return true;
                                    }
                                    if(invalidX.includes(x)) {
                                        if([0, 1, 2, 3].includes(x))
                                            curX += (4 - x);
                                        else
                                            curX -= (5 - (maxX - x))
                                    }
                                    if(table1 == $("#floating")) {
                                        posY = curY;
                                        posX = curX
                                    }
                                    return conflicting(table1, curY, curX, curR, curQ);
                                }
                            } else if(table2.rows[y].cells[x].className && s) {
                                return true;
                            } /*if(table2.rows[y].cells[x].className) {
                                st += "# ";
                            } else {
                                st += "_ ";
                            }*/
                        }
                       // st += "\n";
                    }
                    //console.log(st)
                    return false;
                }

                function rotate_piece(dir = 1) {
                    ogR = posR
                    posR += dir
                    if(posR == 4)
                        posR = 0
                    else if(posR == -1)
                        posR = 3
                    redraw_piece();
                    if(!conflicting()) {
                        predict();
                        return
                    }
                    ogX = posX
                    ogY = posY
                    if("JLSTZ".includes(current_piece)) {
                        var tests;
                        switch(ogR) {
                            case 0: // 0 -> R
                                tests = [
                                    [-1, 0],
                                    [-1, 1],
                                    [0, -2],
                                    [-1, -2]
                                ]
                                break;
                            case 1: // R -> 2
                                tests = [
                                    [1, 0],
                                    [1, -1],
                                    [0, 2],
                                    [1, 2]
                                ]
                                break;
                            case 2: // 2 -> L
                                tests = [
                                    [1, 0],
                                    [1, 1],
                                    [0, -2],
                                    [1, -2]
                                ]
                                break;
                            case 3: // L -> 0
                                tests = [
                                    [-1, 0],
                                    [-1, -1],
                                    [0, 2],
                                    [-1, 2]
                                ]
                                break;
                        }
                    } else {
                        var tests;
                        switch(ogR) {
                            case 0: // 0 -> R
                                tests = [
                                    [-2, 0],
                                    [1, 0],
                                    [-2, -1],
                                    [1, 2]
                                ]
                                break;
                            case 1: // R -> 2
                                tests = [
                                    [-1, 0],
                                    [2, 0],
                                    [-1, 2],
                                    [2, -1]
                                ]
                                break;
                            case 2: // 2 -> L
                                tests = [
                                    [2, 0],
                                    [-1, 0],
                                    [2, 1],
                                    [-1, -2]
                                ]
                                break;
                            case 3: // L -> 0
                                tests = [
                                    [1, 0],
                                    [-2, 0],
                                    [1, -2],
                                    [-2, 1]
                                ]
                                break;
                        }
                    }
                    if(dir == -1) {
                        for(var t of tests)
                            t = [-t[0], -t[1]]
                    }
                    for(var t of tests) {
                        posX = ogX + t[0];
                        posY = ogY + t[1];
                        redraw_piece();
                        if(!conflicting()) {
                            console.log(t, ogR, current_piece)
                            predict();
                            return
                        }
                    }
                    posR -= dir;
                    posY = ogY;
                    posX = ogX;
                    console.log("failed to rotate")
                    redraw_piece();
                    predict();
                }

                function game_over() {
                    alert("Game over!\nScore: " + score)
                    for(table of [$("#grid"), $("#floating"), $("#predict"), $("#dropping")]) {
                        for(var elem of table.querySelectorAll("td[class]"))
                            elem.className = ""
                    }
                    score = 0;
                    fillbag();
                    draw_next_piece();
                    next_piece_on_board();
                }

                function next_piece_on_board(swapping = false) {
                    if(swapping) {
                        redraw_next_piece();
                    } else {
                        current_piece = next_piece
                        draw_next_piece()
                    }
                    posX = Math.floor((maxX - pieces[current_piece][0].length) / 2)
                    posY = 3
                    posR = 0
                    if(conflicting()) {
                        posY += 1
                        redraw_piece()
                    }
                    predict();
                    if(conflicting()) {
                        game_over();
                    }
                }

                function move_piece_left(dir = 1) {
                    posX -= dir
                    while(conflicting()) {
                        posX += dir
                        redraw_piece()
                    }
                    predict();
                }

                function fix_cleared() {
                    table = $("#grid")
                    cleared = 0
                    just_cleared = false;

                    for(var y = 0; y < maxY; y += 1) {
                        if(table.rows[y].className == "cleared") {
                            table.rows[y].remove()
                            table.insertRow(0);
                            for(var x = 0; x < maxX; x += 1)
                                table.rows[0].insertCell();
                            cleared += 1;
                            cleared_total += 1;
                            level = Math.ceil(cleared_total / 16)
                        } else if(cleared) {
                            switch(cleared) {
                                case 1:
                                    score += 40 * level;
                                    break;
                                case 2:
                                    score += 100 * level;
                                    if(garbage_enabled)
                                        add_garbage();
                                    break;
                                case 3:
                                    score += 300 * level;
                                    if(garbage_enabled) {
                                        add_garbage();
                                        add_garbage();
                                    }
                                    break;
                                case 4:
                                    score += 1200 * level;
                                    if(garbage_enabled) {
                                        add_garbage();
                                        add_garbage();
                                        add_garbage();
                                        add_garbage();
                                    }
                                    break;
                            }
                            cleared = 0;
                        }
                    }
                    predict();
                }

                var down_interval = 0;
                function change_interval() {
                    window.clearInterval(down_interval);
                    if(Number(interval))
                        down_interval = window.setInterval(move_piece_down, 2000 - 190 * interval)
                }

                function move_piece_down() {
                    if(posY == preY) {
                        table1 = $("#floating")
                        table2 = $("#grid")
                        for(var y = posY; y < posY + pieces[current_piece][posR].length; y += 1) {
                            for(var x = posX; x < posX + pieces[current_piece][posR][0].length; x += 1) {
                                c = table1.rows[y].cells[x]
                                if(c.className)
                                    table2.rows[y].cells[x].className = c.className;
                            }
                        }
                        next_piece_on_board();
                        predict();
                        for(var row of table2.rows) {
                            cleared = 0;
                            for(var cell of row.cells) {
                                if(cell.className)
                                    cleared += 1;
                            }
                            if(cleared == maxX - 8)
                                row.className = "cleared"
//                             else if(cleared)
//                                 console.log(cleared)
                        }
                        window.setTimeout(fix_cleared, 500)
                        return true;
                    }
                    posY += 1
                    redraw_piece();
                    return false;
                }

                function move_piece_right() { move_piece_left(-1) }

                function swap_piece() {
                    [current_piece, next_piece] = [next_piece, current_piece]
                    next_piece_on_board(true)
                    predict();
                }

                thisX = 0;
                thisY = 0;
                thisR = 0;
                thisP = 0;
                thisQ = 0;
                blocking_enter = false
                function drop_piece() {
                    thisX = posX;
                    thisY = posY;
                    thisR = posR;
                    thisP = preY;
                    thisQ = current_piece;
                    timed = 0;
                    blocking_enter = true;
                    next_piece_on_board();
                    predict();
                    for(var x = 0; x <= thisP - thisY; x += 1) {
                        window.setTimeout(() => {
                            thisY += 1;
                            if(conflicting($("#dropping"), thisY, thisX, thisR, thisQ)) {
                                thisY -= 1
                                redraw_piece($("#dropping"), thisY, thisX, thisR, thisQ);
                            }
                        }, 7 * x)
                        timed = x;
                    }
                    window.setTimeout(() => {
                        table1 = $("#dropping")
                        table2 = $("#grid")
                        for(var y = thisY; y < thisY + pieces[thisQ][thisR].length; y += 1) {
                            for(var x = thisX; x < thisX + pieces[thisQ][thisR][0].length; x += 1) {
                                c = table1.rows[y].cells[x]
                                if(c.className)
                                    table2.rows[y].cells[x].className = c.className;
                            }
                        }
                        predict();
                        for(var row of table2.rows) {
                            cleared = 0;
                            for(var cell of row.cells) {
                                if(cell.className)
                                    cleared += 1;
                            }
                            if(cleared == maxX - 8)
                                row.className = "cleared"
    //                             else if(cleared)
    //                                 console.log(cleared)
                        }
                        window.setTimeout(fix_cleared, 500)
                        for(var elem of $("#dropping").querySelectorAll("td[class]"))
                            elem.className = ""
                        if(conflicting())
                            game_over();
                        blocking_enter = false
                    }, (timed + 1) * 7)
                }

                window.onkeydown = (evt) => {
                    switch(evt.key) {
                        case "ArrowUp":
                        case "w":
                        case "W":
                        case "e":
                        case "E":
                            rotate_piece();
                            evt.preventDefault();
                            break;
                        case "/":
                        case "?":
                        case "q":
                        case "Q":
                        case "Z":
                        case "z":
                            rotate_piece(-1);
                            evt.preventDefault();
                            break;
                        case "ArrowLeft":
                        case "a":
                        case "A":
                            move_piece_left();
                            evt.preventDefault();
                            break;
                        case "ArrowRight":
                        case "d":
                        case "D":
                            move_piece_right();
                            evt.preventDefault();
                            break;
                        case "ArrowDown":
                        case "s":
                        case "S":
                            move_piece_down();
                            evt.preventDefault();
                            break;
                        case "Enter":
                        case " ":
                            if(blocking_enter)
                                break;
                            drop_piece();
                            evt.preventDefault();
                            break;
                        case "C":
                        case "c":
                        case "Control":
                            swap_piece();
                            evt.preventDefault();
                            break;
                        case "g":
                        case "G":
                            add_garbage();
                            evt.preventDefault();
                            break;
                    }
                }

                if(Number(localStorage.getItem("__tetris__garbage"))) {
                    $("#garbage").checked = true;
                    garbage_enabled = true;
                } else {
                    $("#garbage").checked = false;
                    garbage_enabled = false;
                } if(localStorage.getItem("__tetris__speed")) {
                    interval = Number(localStorage.getItem("__tetris__speed")) || 0
                    $("#speed").value = interval;
                } else {
                    var interval = 5
                    $("#speed").value = interval;
                } if(localStorage.getItem('__tetris__ghost')) {
                    $("#ghost").checked = true;
                    if(Number(localStorage.getItem('__tetris__ghost')) || 0) {
                        $("#ghost").checked = !$("#predict").classList.toggle("noopac")
                    }
                } else {
                    $("#ghost").checked = true;
                } if(Number(localStorage.getItem("__tetris__height"))) {
                    maxY = Number(localStorage.getItem("__tetris__height"))
                    $("#height").value = maxY - 8;
                } else {
                    maxY = 28;
                    $("#height").value = maxY - 8;
                } if(Number(localStorage.getItem("__tetris__width"))) {
                    maxX = Number(localStorage.getItem("__tetris__width"))
                    console.log(maxX)
                    $("#width").value = maxX - 8;
                } else {
                    maxX = 18;
                    $("#width").value = maxX - 8;
                } if(Number(localStorage.getItem("__tetris__extras"))) {
                    extra_bits = Number(localStorage.getItem("__tetris__extras"));
                    $("#extras").checked = extra_bits;
                } else {
                    extra_bits = false;
                    $("#extras").checked = extra_bits;
                }

                board_size();
                change_interval();
            </script>
        </div>

            <link rel="stylesheet" type="text/css" href="/prizm.dev/assets/css/fonts.css">
        </div>
    </body>
</html>
